var map = L.map('map').setView([18.790679983131618, 98.98615363854256], 13);

const osm = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
});

const Esri_WorldImagery = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
    attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
});

const CartoDB_Positron = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
    subdomains: 'abcd',
    maxZoom: 20
});

const Esri_WorldStreetMap = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}', {
    attribution: 'Tiles &copy; Esri &mdash; Source: Esri, DeLorme, NAVTEQ, USGS, Intermap, iPC, NRCAN, Esri Japan, METI, Esri China (Hong Kong), Esri (Thailand), TomTom, 2012'
});

const roadMap = L.tileLayer('https://mt1.google.com/vt/lyrs=r&x={x}&y={y}&z={z}', {
    maxZoom: 20,
    attribution: '&copy; <a href="https://maps.google.com">Google Maps</a>'
});

const satelliteMap = L.tileLayer('https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
    maxZoom: 20,
    attribution: '&copy; <a href="https://maps.google.com">Google Maps</a>'
});

const terrainMap = L.tileLayer('https://mt1.google.com/vt/lyrs=p&x={x}&y={y}&z={z}', {
    maxZoom: 20,
    attribution: '&copy; <a href="https://maps.google.com">Google Maps</a>'
});

const hybridMap = L.tileLayer('https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}', {
    maxZoom: 20,
    attribution: '&copy; <a href="https://maps.google.com">Google Maps</a>'
})

const bingMaps = L.tileLayer('https://t.ssl.ak.tiles.virtualearth.net/tiles/r{q}?g=129&mkt=en-US&shading=hill&stl=H', {
    maxZoom: 19,
    attribution: '&copy; <a href="https://www.bing.com/maps">Bing Maps</a>'
});

const basemaps = {
    "แผนที่ถนน OSM": osm,
    "แผนที่ถนน CartoDB": CartoDB_Positron,
    "แผนที่ถนน Google": roadMap,
    "แผนที่จากดาวเทียม ESRI": Esri_WorldImagery,
    "แผนที่จากดาวเทียม bingMaps": bingMaps,
    "แผนที่จากดาวเทียม Google": satelliteMap.addTo(map),
    "แผนที่จากดาวเทียม Google-ชื่อสถานที่": hybridMap,
    "แผนที่ภูมิประเทศ Google": terrainMap,
}

var markerGroup = L.layerGroup().addTo(map);
var bmbound = L.layerGroup().addTo(map);
const overlay = {
    "ตำแหน่งบ้าน": markerGroup.addTo(map),
    "ขอบเขตหมู่บ้าน": bmbound.addTo(map)
}
L.control.layers(basemaps, overlay).addTo(map);

// const bm_bound = {
//     "type": "FeatureCollection",
//     "name": "bm_bound",
//     "crs": { "type": "name", "properties": { "name": "urn:ogc:def:crs:OGC:1.3:CRS84" } },
//     "features": [
//         { "type": "Feature", "properties": { "id": 1 }, "geometry": { "type": "MultiPolygon", "coordinates": [[[[99.066487491112156, 18.550259416381802], [99.067532215446008, 18.550694245629082], [99.068638236007061, 18.55043339052941], [99.069210203544969, 18.550227992532687], [99.069634846111015, 18.550071889889928], [99.070488464330495, 18.549209214816791], [99.070601124603115, 18.549435153947687], [99.071259753889237, 18.549221538777086], [99.0713377494626, 18.54964876885105], [99.071513239502622, 18.549579960233473], [99.071712561523427, 18.549444396905763], [99.072033209991645, 18.549156837975573], [99.072977823046728, 18.548680310682197], [99.07325080755345, 18.549222565773736], [99.077266496309306, 18.548335238363734], [99.080685955223231, 18.547972655389348], [99.080485173031846, 18.547540961223202], [99.081152056738986, 18.547085471707238], [99.080743321563645, 18.546249271373743], [99.080298732425518, 18.545331485806919], [99.079258967505766, 18.545130932007911], [99.078850232330367, 18.544240334326773], [99.076103818783679, 18.544661839151647], [99.071838225744401, 18.544155282402258], [99.070681281636283, 18.543751376494765], [99.070050517367548, 18.545158701232101], [99.070015005148619, 18.547217708793902], [99.0696776390688, 18.547394464545611], [99.069295882715338, 18.547613304746633], [99.06897183371764, 18.54782372775238], [99.068752101863041, 18.548148830786481], [99.068428052865343, 18.548573883657955], [99.067460344899558, 18.549150438832271], [99.067398198516443, 18.549255649420463], [99.066674637055812, 18.549567072381592], [99.066487491112156, 18.550259416381802]]]] } },
//         { "type": "Feature", "properties": { "id": 2 }, "geometry": { "type": "MultiPolygon", "coordinates": [[[[99.065673718480028, 18.551609958387935], [99.066424941766499, 18.550490816877812], [99.066674637055812, 18.549567072381592], [99.067398198516443, 18.549255649420463], [99.067460344899558, 18.549150438832271], [99.068428052865343, 18.548573883657955], [99.068752101863041, 18.548148830786481], [99.06897183371764, 18.54782372775238], [99.069295882715338, 18.547613304746633], [99.0696776390688, 18.547394464545611], [99.070015005148619, 18.547217708793902], [99.070050517367548, 18.545158701232101], [99.070681281636283, 18.543751376494765], [99.069440023179439, 18.543318035229678], [99.067615887000258, 18.540736073393155], [99.063688853202578, 18.543007573536183], [99.062620972933132, 18.543625263708911], [99.060641248668063, 18.544718870532932], [99.061946042546836, 18.54624380454467], [99.061358026884378, 18.546540854815674], [99.06213918637755, 18.547939629112488], [99.062529766124186, 18.547728033445271], [99.064081354897723, 18.549555072006513], [99.064695842318585, 18.550348045324121], [99.065673718480028, 18.551609958387935]]]] } },
//         { "type": "Feature", "properties": { "id": 5 }, "geometry": { "type": "MultiPolygon", "coordinates": [[[[99.071792505173008, 18.55700182060313], [99.07160200020185, 18.556958549793933], [99.070997160374375, 18.556733113142389], [99.070237233411618, 18.556439064888536], [99.069818498146432, 18.55784559111882], [99.069818498146432, 18.557982812569467], [99.068526105352689, 18.55854639951318], [99.068829817659221, 18.561032285799786], [99.067997516700032, 18.561181756369091], [99.06806177493867, 18.56299969081622], [99.06966803246992, 18.563135645287105], [99.070342086969603, 18.562571433524845], [99.070539283764745, 18.562471166781481], [99.070783090711458, 18.562063301455403], [99.07082611546673, 18.561737008492543], [99.070883481807144, 18.561560266210481], [99.071672268987655, 18.56115239870698], [99.07177983087594, 18.560921273355561], [99.07306340274242, 18.559901598950404], [99.07317275732882, 18.559454639748747], [99.075897658497865, 18.559128341797624], [99.076611152356605, 18.55915043490775], [99.07623110035145, 18.557083866996884], [99.075657436947395, 18.557248717493749], [99.075322801085733, 18.557497138445576], [99.073734167925011, 18.557570766650787], [99.073557653129384, 18.557028594577304], [99.073388198925571, 18.556954966138203], [99.073176381170796, 18.557008514097067], [99.072943381640542, 18.557115609964381], [99.072526806722863, 18.557142383920723], [99.072357352519049, 18.557162464385215], [99.072053747070541, 18.557222705764509], [99.071792505173008, 18.55700182060313]]]] } },
//         { "type": "Feature", "properties": { "id": 6 }, "geometry": { "type": "MultiPolygon", "coordinates": [[[[99.072039625886902, 18.552913720143685], [99.071505522335144, 18.553176342180198], [99.071017005502426, 18.55326540523485], [99.070133917381725, 18.55326540523485], [99.069598427776654, 18.55320306110147], [99.068968992626793, 18.553105091703021], [99.06841471391273, 18.553060560139667], [99.06774770054497, 18.553185248487754], [99.067437680247295, 18.553372280839113], [99.066967952523513, 18.55386212650248], [99.066747180493323, 18.554171619174276], [99.066427765641137, 18.554465525364741], [99.066070772571109, 18.55488411815633], [99.065920459699484, 18.555115679685162], [99.065638623065212, 18.555792550045172], [99.065413153757802, 18.556879099483954], [99.069997696341844, 18.557244249791633], [99.070237233411618, 18.556439064888536], [99.070997160374375, 18.556733113142389], [99.07160200020185, 18.556958549793933], [99.071792505173008, 18.55700182060313], [99.071933717009514, 18.556232067049265], [99.072067868254209, 18.55586392281807], [99.072145534764289, 18.555644709285048], [99.072173777131596, 18.555256483100646], [99.072180837723394, 18.554988740390044], [99.072251443641662, 18.55476115875582], [99.072272625417156, 18.554533576818184], [99.072166716539769, 18.553971314259677], [99.072032565295089, 18.553549616125423], [99.072081989437862, 18.553415743484006], [99.072081989437862, 18.553228321609655], [99.072039625886902, 18.552913720143685]]]] } },
//         { "type": "Feature", "properties": { "id": 7 }, "geometry": { "type": "MultiPolygon", "coordinates": [[[[99.065413153757802, 18.556879099483954], [99.063257742215015, 18.556600856147337], [99.062218185495539, 18.556322026428589], [99.059674652359206, 18.557052862324124], [99.059217994865605, 18.557344963056703], [99.059458599351473, 18.5575637473417], [99.059566625855339, 18.557819771148861], [99.059915256845073, 18.558643699703204], [99.060126399557163, 18.559132468999724], [99.060371206904108, 18.559650931214144], [99.06164750100254, 18.562234944898947], [99.062335897087365, 18.563715150004167], [99.062514356085174, 18.564082795595066], [99.062805370696921, 18.563923868920739], [99.063228646904633, 18.563721796277896], [99.063577192058517, 18.563540045398632], [99.064203887698312, 18.563042175542019], [99.064594643731638, 18.562730744704069], [99.064860557780634, 18.56269276003443], [99.065311775995667, 18.563251206502169], [99.065863927022065, 18.563183229326313], [99.066710080542975, 18.563142443007802], [99.06806177493867, 18.56299969081622], [99.067997516700032, 18.561181756369091], [99.068829817659221, 18.561032285799786], [99.068526105352689, 18.55854639951318], [99.069818498146432, 18.557982812569467], [99.069818498146432, 18.55784559111882], [99.069997696341844, 18.557244249791633], [99.065413153757802, 18.556879099483954]]]] } },
//         { "type": "Feature", "properties": { "id": 8 }, "geometry": { "type": "MultiPolygon", "coordinates": [[[[99.063257742215015, 18.556600856147337], [99.065413153757802, 18.556879099483954], [99.065638623065212, 18.555792550045172], [99.065920459699484, 18.555115679685162], [99.066070772571109, 18.55488411815633], [99.066427765641137, 18.554465525364741], [99.066747180493323, 18.554171619174276], [99.066967952523513, 18.55386212650248], [99.067437680247295, 18.553372280839113], [99.06774770054497, 18.553185248487754], [99.06841471391273, 18.553060560139667], [99.068968992626793, 18.553105091703021], [99.069598427776654, 18.55320306110147], [99.070133917381725, 18.55326540523485], [99.071017005502426, 18.55326540523485], [99.071505522335144, 18.553176342180198], [99.072039625886902, 18.552913720143685], [99.072429723585273, 18.552804948225369], [99.072330875299699, 18.552664381335951], [99.072286746600781, 18.552383247209914], [99.072138474172462, 18.551586698005355], [99.072004322927782, 18.551138219086855], [99.071870171683088, 18.550984263365599], [99.071693656887447, 18.550776757608592], [99.071503020908168, 18.550401907859904], [99.071411233214434, 18.550013669752609], [99.0713377494626, 18.54964876885105], [99.071259753889237, 18.549221538777086], [99.070601124603115, 18.549435153947687], [99.070488464330495, 18.549209214816791], [99.069634846111015, 18.550071889889928], [99.069210203544969, 18.550227992532687], [99.068638236007061, 18.55043339052941], [99.067532215446008, 18.550694245629082], [99.066487491112156, 18.550259416381802], [99.066424941766499, 18.550490816877812], [99.065673718480028, 18.551609958387935], [99.064870772253855, 18.553006740643401], [99.064770381158127, 18.553169895548447], [99.063300368685347, 18.553666157426168], [99.062940036359706, 18.554068944259406], [99.063657115614717, 18.555884022501189], [99.063257742215015, 18.556600856147337]]]] } },
//         { "type": "Feature", "properties": { "id": 4 }, "geometry": { "type": "MultiPolygon", "coordinates": [[[[99.072429723585273, 18.552804948225369], [99.072705227464667, 18.552806309571771], [99.073101030631122, 18.552791594528138], [99.073442507872798, 18.552813667093123], [99.073605485647207, 18.552806309571771], [99.074016810506492, 18.552644444021944], [99.07442813536575, 18.552460505710837], [99.074986916306656, 18.552247137021684], [99.075452567090707, 18.552070555835879], [99.075894935335597, 18.551879259345156], [99.07634506442686, 18.551570241484281], [99.076593411511681, 18.551378944432962], [99.076950410446173, 18.551239150298379], [99.077920516246294, 18.551055210473212], [99.080890950518452, 18.550439382511957], [99.080886737414659, 18.550382644499837], [99.080685955223231, 18.547972655389348], [99.077266496309306, 18.548335238363734], [99.07445327939206, 18.548956861361113], [99.07325080755345, 18.549222565773736], [99.072977823046728, 18.548680310682197], [99.072033209991645, 18.549156837975573], [99.071712561523427, 18.549444396905763], [99.071513239502622, 18.549579960233473], [99.0713377494626, 18.54964876885105], [99.071411233214434, 18.550013669752609], [99.071503020908168, 18.550401907859904], [99.071693656887447, 18.550776757608592], [99.071870171683088, 18.550984263365599], [99.072004322927782, 18.551138219086855], [99.072138474172462, 18.551586698005355], [99.072286746600781, 18.552383247209914], [99.072330875299699, 18.552664381335951], [99.072429723585273, 18.552804948225369]]]] } },
//         { "type": "Feature", "properties": { "id": 3 }, "geometry": { "type": "MultiPolygon", "coordinates": [[[[99.080890950518452, 18.550439382511957], [99.077920516246294, 18.551055210473212], [99.076950410446173, 18.551239150298379], [99.076593411511681, 18.551378944432962], [99.07634506442686, 18.551570241484281], [99.075894935335597, 18.551879259345156], [99.075452567090707, 18.552070555835879], [99.074986916306656, 18.552247137021684], [99.07442813536575, 18.552460505710837], [99.074016810506492, 18.552644444021944], [99.073605485647207, 18.552806309571771], [99.073442507872798, 18.552813667093123], [99.073101030631122, 18.552791594528138], [99.072705227464667, 18.552806309571771], [99.072429723585273, 18.552804948225369], [99.072039625886902, 18.552913720143685], [99.072081989437862, 18.553228321609655], [99.072081989437862, 18.553415743484006], [99.072032565295089, 18.553549616125423], [99.072166716539769, 18.553971314259677], [99.072272625417156, 18.554533576818184], [99.072251443641662, 18.55476115875582], [99.072180837723394, 18.554988740390044], [99.072173777131596, 18.555256483100646], [99.072145534764289, 18.555644709285048], [99.072067868254209, 18.55586392281807], [99.071933717009514, 18.556232067049265], [99.071792505173008, 18.55700182060313], [99.072053747070541, 18.557222705764509], [99.072357352519049, 18.557162464385215], [99.072526806722863, 18.557142383920723], [99.072943381640542, 18.557115609964381], [99.073176381170796, 18.557008514097067], [99.073388198925571, 18.556954966138203], [99.073557653129384, 18.557028594577304], [99.073734167925011, 18.557570766650787], [99.075322801085733, 18.557497138445576], [99.075657436947395, 18.557248717493749], [99.074918845314755, 18.555596806349481], [99.074854308181813, 18.555122643716064], [99.075004894825355, 18.5547759433225], [99.07612353846315, 18.55448362675725], [99.075994464197294, 18.553426524302321], [99.076439053335406, 18.553297360209523], [99.07620241718125, 18.552794299127086], [99.077349743989245, 18.552501979168483], [99.080936932962473, 18.551246017372115], [99.080890950518452, 18.550439382511957]]]] } }
//     ]
// }

L.geoJSON(bm_bound, {
    style: function (feature) {
        // border color only
        return {
            color: "yellow",
            weight: 1,
            fillOpacity: 0.0,
            dashArray: '5, 5'

        };
    }
}).addTo(bmbound);

var lc = L.control.locate({
    locateOptions: {
        enableHighAccuracy: true
    }
}).addTo(map);

const redIcon = L.icon({
    iconUrl: './../assets/pin_red.png',
    iconSize: [32, 32],
    iconAnchor: [16, 32],
    popupAnchor: [0, -32]
});

const greenIcon = L.icon({
    iconUrl: './../assets/pin_green.png',
    iconSize: [32, 32],
    iconAnchor: [16, 32],
    popupAnchor: [0, -32]
});

function gotoPage(page) {
    window.location.href = "./../" + page + "/index.html";
}

// get data from server
function getData() {
    fetch('/survey/api/getdata')
        .then(response => response.json())
        .then(data => {
            removeMarker("marker-green");
            markerGroup.clearLayers();
            data.data.forEach(function (item) {
                var marker = L.marker([item.lat, item.lng], { name: "marker-green", icon: greenIcon }).addTo(markerGroup);
                marker.bindPopup('ชื่อ: ' + item.mncptname + '<br>หมู่: ' + item.moo + '<br>บ้านเลขที่: ' + item.hno);
            });
        })
        .catch(error => {
            console.error('Error:', error);
            alert('There was an error getting the data.');
        });
}

function removeMarker(marker) {
    map.eachLayer(function (layer) {
        if (layer.options.name === marker) {
            map.removeLayer(layer);
        }
    });
}

function onclick(e) {
    removeMarker("marker-red");
    L.marker(e.latlng, { name: "marker-red", icon: redIcon })
        .addTo(map)
        .bindPopup('คุณคลิกที่พิกัด ' + e.latlng.toString());
    // console.log(e.latlng);
    formModal.show();

    document.getElementById('latlng').value = e.latlng.lat + ", " + e.latlng.lng;
    document.getElementById('lat').value = e.latlng.lat;
    document.getElementById('lng').value = e.latlng.lng;
}

lc.start();
map.on("click", onclick);
getData();

document.getElementById('surveyForm').addEventListener('submit', function (event) {
    event.preventDefault();

    const formData = new FormData(event.target);
    const mncptname = formData.get('mncptname');
    const hno = formData.get('hno');
    const moo = formData.get('moo');
    const lat = formData.get('lat');
    const lng = formData.get('lng');

    const data = {
        mncptname: mncptname,
        moo: moo,
        hno: hno,
        lat: lat,
        lng: lng
    };

    // Send POST request using fetch
    fetch('/survey/api/insertdata', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
    })
        .then(response => response.json())
        .then(result => {
            formModal.hide();
            getData();
        })
        .catch(error => {
            console.error('Error:', error);
            alert('There was an error submitting the data.');
        });
});

const formModal = new bootstrap.Modal(document.getElementById('formModal'));



